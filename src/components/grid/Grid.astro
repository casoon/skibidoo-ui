---
import type { GridProps, GridColumn } from "../../types/index.js";

interface Props extends GridProps {
  __id?: string;
  __hydrate?: boolean;
}

const {
  columns,
  data,
  pagination = true,
  sorting = true,
  filtering = false,
  selection = "none",
  rowKey = "id",
  emptyText = "Keine Daten vorhanden",
  loading = false,
  className = "",
  __id = "grid",
  __hydrate = false,
} = Astro.props;

const paginationConfig = typeof pagination === "object" ? pagination : { pageSize: 10 };
const pageSize = paginationConfig.pageSize ?? 10;
const totalPages = Math.ceil(data.length / pageSize);
const displayData = data.slice(0, pageSize);
---

<div
  class:list={["ui-grid", className, { "ui-grid--loading": loading }]}
  id={__id}
  data-component="grid"
  data-props={JSON.stringify({ columns: columns.map(c => c.field), pagination, sorting, filtering, selection, rowKey, pageSize })}
>
  {loading && (
    <div class="ui-grid__loader">
      <div class="ui-grid__spinner"></div>
    </div>
  )}

  {filtering && (
    <div class="ui-grid__toolbar">
      <input type="text" class="ui-grid__search" placeholder="Suchen..." data-action="search" />
    </div>
  )}

  <div class="ui-grid__wrapper">
    <table class="ui-grid__table">
      <thead class="ui-grid__head">
        <tr>
          {selection !== "none" && (
            <th class="ui-grid__header ui-grid__header--checkbox">
              {selection === "multiple" && (
                <input type="checkbox" class="ui-grid__checkbox-all" data-action="select-all" />
              )}
            </th>
          )}
          {columns.map((col: GridColumn) => (
            <th
              class:list={[
                "ui-grid__header",
                { "ui-grid__header--sortable": sorting && col.sortable !== false },
                col.align ? `ui-grid__header--${col.align}` : "",
              ]}
              data-field={col.field}
              style={col.width ? `width: ${typeof col.width === "number" ? col.width + "px" : col.width}` : ""}
            >
              <span class="ui-grid__header-text">{col.label}</span>
              {sorting && col.sortable !== false && (
                <span class="ui-grid__sort-icon" data-sort="none"></span>
              )}
            </th>
          ))}
        </tr>
      </thead>
      <tbody class="ui-grid__body">
        {displayData.length === 0 ? (
          <tr class="ui-grid__row ui-grid__row--empty">
            <td class="ui-grid__cell" colspan={columns.length + (selection !== "none" ? 1 : 0)}>
              {emptyText}
            </td>
          </tr>
        ) : (
          displayData.map((row: Record<string, unknown>, idx: number) => (
            <tr class="ui-grid__row" data-row-key={row[rowKey] ?? idx}>
              {selection !== "none" && (
                <td class="ui-grid__cell ui-grid__cell--checkbox">
                  <input type="checkbox" class="ui-grid__checkbox" data-action="select-row" />
                </td>
              )}
              {columns.map((col: GridColumn) => (
                <td
                  class:list={["ui-grid__cell", col.align ? `ui-grid__cell--${col.align}` : ""]}
                  data-field={col.field}
                >
                  {String(row[col.field] ?? "")}
                </td>
              ))}
            </tr>
          ))
        )}
      </tbody>
    </table>
  </div>

  {pagination && totalPages > 1 && (
    <div class="ui-grid__pagination">
      <button class="ui-grid__page-btn" data-action="first" disabled>&laquo;</button>
      <button class="ui-grid__page-btn" data-action="prev" disabled>&lsaquo;</button>
      <span class="ui-grid__page-info">
        Seite <span data-page-current>1</span> von <span data-page-total>{totalPages}</span>
      </span>
      <button class="ui-grid__page-btn" data-action="next">&rsaquo;</button>
      <button class="ui-grid__page-btn" data-action="last">&raquo;</button>
      {paginationConfig.showTotal && (
        <span class="ui-grid__total">({data.length} Eintraege)</span>
      )}
    </div>
  )}
</div>

{__hydrate && (
  <script define:vars={{ gridId: __id }}>
    window.__UI_HYDRATE__ = window.__UI_HYDRATE__ || [];
    window.__UI_HYDRATE__.push(gridId);
  </script>
)}

<style>
  .ui-grid {
    --grid-border-color: var(--ui-border-color, #e0e0e0);
    --grid-header-bg: var(--ui-surface-variant, #f5f5f5);
    --grid-row-hover: var(--ui-hover, #f9f9f9);
    --grid-row-selected: var(--ui-primary-light, #e3f2fd);

    position: relative;
    border: 1px solid var(--grid-border-color);
    border-radius: var(--ui-radius, 4px);
    background: var(--ui-surface, #fff);
    font-family: var(--ui-font-family, system-ui, sans-serif);
    font-size: var(--ui-font-size, 14px);
  }

  .ui-grid--loading {
    pointer-events: none;
    opacity: 0.7;
  }

  .ui-grid__loader {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.8);
    z-index: 10;
  }

  .ui-grid__spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--grid-border-color);
    border-top-color: var(--ui-primary, #0066cc);
    border-radius: 50%;
    animation: ui-spin 0.8s linear infinite;
  }

  @keyframes ui-spin {
    to { transform: rotate(360deg); }
  }

  .ui-grid__toolbar {
    padding: var(--ui-space-sm, 8px);
    border-bottom: 1px solid var(--grid-border-color);
  }

  .ui-grid__search {
    width: 100%;
    max-width: 300px;
    padding: var(--ui-space-xs, 4px) var(--ui-space-sm, 8px);
    border: 1px solid var(--grid-border-color);
    border-radius: var(--ui-radius, 4px);
    font-size: inherit;
  }

  .ui-grid__wrapper {
    overflow-x: auto;
  }

  .ui-grid__table {
    width: 100%;
    border-collapse: collapse;
  }

  .ui-grid__header {
    padding: var(--ui-space-sm, 8px) var(--ui-space-md, 12px);
    background: var(--grid-header-bg);
    border-bottom: 2px solid var(--grid-border-color);
    text-align: left;
    font-weight: 600;
    white-space: nowrap;
    user-select: none;
  }

  .ui-grid__header--sortable {
    cursor: pointer;
  }

  .ui-grid__header--sortable:hover {
    background: var(--ui-hover, #eee);
  }

  .ui-grid__header--center { text-align: center; }
  .ui-grid__header--right { text-align: right; }
  .ui-grid__header--checkbox { width: 40px; text-align: center; }

  .ui-grid__sort-icon {
    display: inline-block;
    margin-left: 4px;
    opacity: 0.3;
  }

  .ui-grid__sort-icon::after {
    content: "95";
  }

  .ui-grid__sort-icon[data-sort="asc"]::after {
    content: "91";
    opacity: 1;
  }

  .ui-grid__sort-icon[data-sort="desc"]::after {
    content: "93";
    opacity: 1;
  }

  .ui-grid__row {
    border-bottom: 1px solid var(--grid-border-color);
    transition: background 0.15s;
  }

  .ui-grid__row:hover {
    background: var(--grid-row-hover);
  }

  .ui-grid__row--selected {
    background: var(--grid-row-selected);
  }

  .ui-grid__row--empty {
    text-align: center;
    color: var(--ui-text-muted, #888);
  }

  .ui-grid__cell {
    padding: var(--ui-space-sm, 8px) var(--ui-space-md, 12px);
  }

  .ui-grid__cell--center { text-align: center; }
  .ui-grid__cell--right { text-align: right; }
  .ui-grid__cell--checkbox { width: 40px; text-align: center; }

  .ui-grid__pagination {
    display: flex;
    align-items: center;
    gap: var(--ui-space-sm, 8px);
    padding: var(--ui-space-sm, 8px) var(--ui-space-md, 12px);
    border-top: 1px solid var(--grid-border-color);
    background: var(--grid-header-bg);
  }

  .ui-grid__page-btn {
    padding: var(--ui-space-xs, 4px) var(--ui-space-sm, 8px);
    border: 1px solid var(--grid-border-color);
    border-radius: var(--ui-radius, 4px);
    background: var(--ui-surface, #fff);
    cursor: pointer;
    transition: background 0.15s;
  }

  .ui-grid__page-btn:hover:not(:disabled) {
    background: var(--ui-hover, #eee);
  }

  .ui-grid__page-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .ui-grid__page-info {
    margin: 0 var(--ui-space-sm, 8px);
  }

  .ui-grid__total {
    margin-left: auto;
    color: var(--ui-text-muted, #888);
  }
</style>
